<%- include('../partials/header') %>
<%- include('../partials/nav') %>

<% if (message && message.length > 0) { %>
  <div class="flash-messages-container animate__animated">
    <div class="flash-message">
      <iconify-icon icon="solar:info-circle-outline" inline class="brand"></iconify-icon><%= message %>
    </div>
  </div>
<% } %>
<div class="container-xxl px-xl-4 px-0">
  <section>
    <div class="row">
      <div class="header-row col-lg-8 col-12">
        <h1>Your assessments</h1>
        <p>Each content item has a category and relevant details such as type and link.</p>
      </div>
      <div class="col-lg-4 col-12 d-flex justify-content-lg-end align-items-start mt-2 mt-lg-0">
        
      </div>
    </div>
  </section>

  <section class="mt-3">
    <div class="row">
      <% responseSets.forEach((response, index) => { %>
        <div class="col-12">
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title"><%= response.assessment_name %></h5>
              <p class="card-text">Response Date: <%= response.response_date %></p>
              <button class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#offcanvas<%= response.response_set_id %>">
                View Details
              </button>
            </div>
          </div>
  
          <!-- Offcanvas for response set -->
          <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvas<%= response.response_set_id %>" aria-labelledby="offcanvasLabel<%= response.response_set_id %>">
            <div class="offcanvas-header">
              <h5 class="offcanvas-title" id="offcanvasLabel<%= response.response_set_id %>"><%= response.assessment_name %></h5>
              <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
              <p>Loading...</p>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  </section>
  
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.offcanvas').forEach(offcanvas => {
        offcanvas.addEventListener('show.bs.offcanvas', async event => {
          const offcanvasElement = event.target;
          const responseSetId = offcanvasElement.id.replace('offcanvas', '');
          
          // Fetch scores and questions for the response set
          const { data: details, error } = await fetch(`/assessments/getResponseDetails/${responseSetId}`).then(res => res.json());
  
          if (error) {
            offcanvasElement.querySelector('.offcanvas-body').innerHTML = '<p>Error loading details.</p>';
          } else {
            let html = '<ul>';
            details.forEach(detail => {
              html += `<li>${detail.questions.question}: ${detail.response_value}</li>`;
            });
            html += '</ul>';
            offcanvasElement.querySelector('.offcanvas-body').innerHTML = html;
          }
        });
      });
    });
  </script>

<%- include('../partials/footer') %>
