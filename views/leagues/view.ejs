<%- include('../partials/header') %>
<%- include('../partials/nav') %>

<% if (message && message.length > 0) { %>
  <div class="flash-messages-container animate__animated">
    <div class="flash-message">
      <iconify-icon icon="solar:info-circle-outline" inline class="brand"></iconify-icon><%= message %>
    </div>
  </div>
<% } %>
<div class="container-xxl px-xl-4 px-0">
  <section>
    <div class="row">
      <div class="header-row col-lg-8 col-12">
        <h1>My assessments</h1>
        <p>View your latest wellness asssessments below</p>
      </div>
      <div class="col-lg-4 col-12 d-flex justify-content-lg-end align-items-start mt-2 mt-lg-0">
        
      </div>
    </div>
  </section>

  <section class="mt-3">
    <div class="row">
      <% responseSets.forEach((response, index) => { %>
        <div class="col-12 mb-3 card px-3 py-3 d-flex flex-row justify-content-between align-items-center">
          <div>
            <p class="font-14 support-text">Completed: 
              <%= 
                new Date(response.response_date).toLocaleDateString('en-GB', {
                  day: '2-digit',
                  month: '2-digit',
                  year: 'numeric'
                })
              %>
            </p>
            
            <p class="fw-medium"><%= response.assessment_name %></p>
          </div>
          <a class="ms-auto unstyled font-14" data-bs-toggle="offcanvas" data-bs-target="#offcanvas<%= response.response_set_id %>">
            View ->
          </a>
    
          <!-- Offcanvas for response set -->
          <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvas<%= response.response_set_id %>" aria-labelledby="offcanvasLabel<%= response.response_set_id %>">
            <div class="offcanvas-header">
              <h5 class="offcanvas-title" id="offcanvasLabel<%= response.response_set_id %>"><%= response.assessment_name %></h5>
              <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
              <p>Loading...</p>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
    
  </section>
  
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.offcanvas').forEach(offcanvas => {
    offcanvas.addEventListener('show.bs.offcanvas', async event => {
      const offcanvasElement = event.target;
      const responseSetId = offcanvasElement.id.replace('offcanvas', '');

      // Fetch scores and questions for the response set
      const { data: details, error } = await fetch(`/assessments/getResponseDetails/${responseSetId}`).then(res => res.json());

      if (error) {
        offcanvasElement.querySelector('.offcanvas-body').innerHTML = '<p>Error loading details.</p>';
      } else {
        let html = '';
        details.forEach(detail => {
          html += `<div class="row mb-2 mt-3">
                     <div class="col-12">
                       <div class="py-2 px-2 font-14" style="border-radius:var(--base-border-radius); background-color: #${detail.categoryBackgroundColor}; color: #${detail.categoryColor};">
                         <span class="fw-medium">${detail.categoryName}</span>
                       </div>
                     </div>
                   </div>`;
          html += '<div class="d-flex flex-column gap-2">';
          detail.questions.forEach(question => {
            html += `<div class="d-flex justify-content-between flex-row"><span class="form-text">${question.question}:</span> <span class="font-14 form-text fw-medium"> ${question.response_value}</span></div>`;
          });
          html += '</div>';
        });
        offcanvasElement.querySelector('.offcanvas-body').innerHTML = html;
      }
    });
  });
});

  </script>

<%- include('../partials/footer') %>
